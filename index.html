<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Pairings Guide</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS/xlsx library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Simple transition for wizard steps */
        .guide-step {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Calendar specific styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            min-height: 100px;
        }
        .calendar-event {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">

            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">The Pairings Guide</h1>
                <p class="text-gray-500 mt-2">A simple tool to pair trainers and trainees, view schedules, and generate posts.</p>
            </div>

            <!-- Step Indicator -->
            <div class="flex justify-center items-center mb-8">
                <div id="step-indicator-1" class="flex items-center"><span class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">1</span><span class="ml-2 text-gray-700 font-medium hidden sm:inline">Input</span></div>
                <div class="flex-1 h-px bg-gray-300 mx-2"></div>
                <div id="step-indicator-2" class="flex items-center opacity-50"><span class="w-8 h-8 rounded-full bg-gray-400 text-white flex items-center justify-center font-bold">2</span><span class="ml-2 text-gray-500 font-medium hidden sm:inline">Trainers</span></div>
                <div class="flex-1 h-px bg-gray-300 mx-2"></div>
                <div id="step-indicator-3" class="flex items-center opacity-50"><span class="w-8 h-8 rounded-full bg-gray-400 text-white flex items-center justify-center font-bold">3</span><span class="ml-2 text-gray-500 font-medium hidden sm:inline">Pairs</span></div>
                <div class="flex-1 h-px bg-gray-300 mx-2"></div>
                <div id="step-indicator-4" class="flex items-center opacity-50"><span class="w-8 h-8 rounded-full bg-gray-400 text-white flex items-center justify-center font-bold">4</span><span class="ml-2 text-gray-500 font-medium hidden sm:inline">Schedule</span></div>
                <div class="flex-1 h-px bg-gray-300 mx-2"></div>
                <div id="step-indicator-5" class="flex items-center opacity-50"><span class="w-8 h-8 rounded-full bg-gray-400 text-white flex items-center justify-center font-bold">5</span><span class="ml-2 text-gray-500 font-medium hidden sm:inline">Post</span></div>
            </div>

            <!-- Guide Content -->
            <div id="guide-content">
                <!-- Step 1: Choose Input Method -->
                <div id="step-1" class="guide-step">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">How would you like to add trainees?</h2>
                    <div class="flex justify-center items-center gap-8 mt-8">
                        <button id="choose-upload-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors text-lg">Upload Spreadsheet</button>
                        <button id="choose-manual-btn" class="bg-gray-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-700 transition-colors text-lg">Enter Manually</button>
                    </div>
                </div>

                <!-- Step 1b: Upload or Manual Entry -->
                <div id="step-1-data" class="guide-step hidden">
                    <!-- Upload Section -->
                    <div id="upload-section" class="hidden">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Upload Trainee Excel Sheet</h2>
                        <p class="text-gray-600 mb-6">Upload an Excel file (.xlsx, .xls, .csv). It must contain columns for <code class="bg-gray-200 p-1 rounded">'First'</code> name, <code class="bg-gray-200 p-1 rounded">'Last'</code> name, and <code class="bg-gray-200 p-1 rounded">'MARKET'</code>.</p>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <input type="file" id="excel-file" class="hidden" accept=".xlsx, .xls, .csv">
                            <label for="excel-file" class="cursor-pointer text-blue-600 font-semibold">Click here to select your file</label>
                            <p id="file-name" class="mt-2 text-gray-500"></p>
                        </div>
                        <div id="data-preview" class="mt-6 hidden max-h-64 overflow-y-auto">
                            <h3 class="font-semibold mb-2">Data Preview:</h3>
                            <table class="min-w-full bg-white border"><thead id="preview-header" class="bg-gray-200"></thead><tbody id="preview-body"></tbody></table>
                        </div>
                    </div>
                    <!-- Manual Entry Section -->
                    <div id="manual-section" class="hidden">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Manually Enter Trainees</h2>
                        <p class="text-gray-600 mb-6">Add your trainees below. You can add as many as you need.</p>
                        <div id="manual-trainees-list" class="space-y-4"></div>
                        <button id="add-manual-trainee-btn" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">+ Add Another Trainee</button>
                    </div>
                </div>

                <!-- Step 2: Input Trainers -->
                <div id="step-2" class="guide-step hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Step 2: Add Trainers & Regions</h2>
                    <p class="text-gray-600 mb-6">Enter trainer names and select their market/region. This data will be saved in your browser for next time.</p>
                    <div id="trainers-list" class="space-y-4"></div>
                    <button id="add-trainer-btn" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">+ Add Another Trainer</button>
                </div>

                <!-- Step 3: Pair Trainees -->
                <div id="step-3" class="guide-step hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Step 3: Create Pairings</h2>
                    <p class="text-gray-600 mb-6">Assign a trainer, enter the Order #, and set the training dates for each trainee.</p>
                    <div id="pairing-container" class="space-y-6 max-h-[50vh] overflow-y-auto pr-2"></div>
                </div>

                <!-- Step 4: Calendar Schedule -->
                <div id="step-4" class="guide-step hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Step 4: Training Schedule</h2>
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="bg-gray-200 p-2 rounded-lg">&lt;</button>
                        <h3 id="calendar-month-year" class="text-xl font-semibold"></h3>
                        <button id="next-month-btn" class="bg-gray-200 p-2 rounded-lg">&gt;</button>
                    </div>
                    <div class="calendar-grid text-sm font-bold text-center text-gray-600 mb-2">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendar-grid-body" class="calendar-grid"></div>
                </div>

                <!-- Step 5: Generate Post -->
                <div id="step-5" class="guide-step hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Step 5: Generate and Export</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-2">Announcement Post</h3>
                            <p class="text-gray-600 mb-2">Enter the Market and Week for the post title.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <input type="text" id="market-input" placeholder="e.g., SEPA Market" class="w-full p-2 border border-gray-300 rounded-lg">
                                <input type="text" id="week-input" placeholder="e.g., Week of 8/21/2025" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <textarea id="post-output" rows="10" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm" readonly></textarea>
                            <button id="copy-post-btn" class="mt-4 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Copy Post to Clipboard</button>
                            <span id="copy-success" class="block text-center mt-2 text-green-600 font-semibold hidden">Copied!</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-2">Calendar Events</h3>
                            <p class="text-gray-600 mb-12">Download an .ics file to import these pairings into your calendar (Outlook, Google Calendar, etc.).</p>
                            <button id="download-ics-btn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Download Calendar File (.ics)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="mt-10 flex justify-between items-center">
                <button id="clear-data-btn" class="text-sm text-red-600 hover:underline">Clear Saved Data</button>
                <div>
                    <button id="back-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors hidden">Back</button>
                    <button id="next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors ml-2 hidden">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let currentStep = 1;
        let inputMethod = ''; // 'upload' or 'manual'
        let traineeData = [];
        let trainers = [];
        let pairings = [];
        let uniqueRegions = [];
        let calendarDate = new Date();

        // --- DOM ELEMENTS ---
        const backBtn = document.getElementById('back-btn');
        const nextBtn = document.getElementById('next-btn');
        const fileInput = document.getElementById('excel-file');
        const addTrainerBtn = document.getElementById('add-trainer-btn');
        const copyPostBtn = document.getElementById('copy-post-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const downloadIcsBtn = document.getElementById('download-ics-btn');
        const chooseUploadBtn = document.getElementById('choose-upload-btn');
        const chooseManualBtn = document.getElementById('choose-manual-btn');
        const addManualTraineeBtn = document.getElementById('add-manual-trainee-btn');


        // --- DATA PERSISTENCE (localStorage) ---
        const saveData = () => {
            localStorage.setItem('pairingsGuideData', JSON.stringify({ trainers }));
        };
        
        const loadData = () => {
            const savedData = localStorage.getItem('pairingsGuideData');
            if (savedData) {
                const data = JSON.parse(savedData);
                trainers = data.trainers || [];
            }
        };

        clearDataBtn.addEventListener('click', () => {
            if (window.confirm('Are you sure you want to clear all saved trainer data? This cannot be undone.')) {
                localStorage.removeItem('pairingsGuideData');
                trainers = [];
                location.reload();
            }
        });

        // --- GUIDE NAVIGATION LOGIC ---
        const updateGuideUI = () => {
            document.querySelectorAll('.guide-step').forEach(step => step.classList.add('hidden'));
            
            if (currentStep === 1) {
                if (inputMethod === '') {
                    document.getElementById('step-1').classList.remove('hidden');
                } else {
                    document.getElementById('step-1-data').classList.remove('hidden');
                    document.getElementById('upload-section').classList.toggle('hidden', inputMethod !== 'upload');
                    document.getElementById('manual-section').classList.toggle('hidden', inputMethod !== 'manual');
                }
            } else {
                 document.getElementById(`step-${currentStep}`).classList.remove('hidden');
            }

            // Update indicators
            for (let i = 1; i <= 5; i++) {
                const indicator = document.getElementById(`step-indicator-${i}`);
                const span = indicator.querySelector('span:first-child');
                if (i < currentStep) {
                    span.classList.remove('bg-gray-400', 'bg-blue-600');
                    span.classList.add('bg-green-600');
                    indicator.classList.remove('opacity-50');
                } else if (i === currentStep) {
                    span.classList.remove('bg-gray-400', 'bg-green-600');
                    span.classList.add('bg-blue-600');
                    indicator.classList.remove('opacity-50');
                } else {
                    span.classList.remove('bg-blue-600', 'bg-green-600');
                    span.classList.add('bg-gray-400');
                    indicator.classList.add('opacity-50');
                }
            }
            
            const onChoiceScreen = currentStep === 1 && inputMethod === '';
            backBtn.classList.toggle('hidden', onChoiceScreen);
            nextBtn.classList.toggle('hidden', onChoiceScreen || currentStep === 5);
             if (currentStep === 1 && inputMethod !== '') {
                backBtn.classList.remove('hidden');
            }
        };

        nextBtn.addEventListener('click', () => {
            if (currentStep === 1) {
                if (inputMethod === 'manual') {
                    saveManualTrainees();
                }
                if (traineeData.length === 0) {
                    alert('Please add at least one trainee or upload a valid file.');
                    return;
                }
            }

            if (currentStep < 5) {
                if (currentStep === 2) { 
                    saveTrainers(); 
                    if (trainers.length === 0) { 
                        alert('Please add at least one trainer.');
                        return; 
                    } 
                }
                if (currentStep === 3) { savePairings(); }
                if (currentStep === 4) { generatePost(); }
                
                currentStep++;
                if (currentStep === 4) { renderCalendar(); }
                updateGuideUI();
            }
        });

        backBtn.addEventListener('click', () => {
            if (currentStep === 1 && inputMethod !== '') {
                inputMethod = '';
                traineeData = [];
            } else if (currentStep > 1) {
                 currentStep--;
            }
            updateGuideUI();
        });
        
        // --- STEP 1: CHOOSE METHOD ---
        chooseUploadBtn.addEventListener('click', () => {
            inputMethod = 'upload';
            updateGuideUI();
        });

        chooseManualBtn.addEventListener('click', () => {
            inputMethod = 'manual';
            populateManualTraineeUI();
            updateGuideUI();
        });

        // --- STEP 1b: DATA INPUT ---
        // Upload Logic
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('file-name').textContent = `Selected: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonDataRaw = XLSX.utils.sheet_to_json(ws);
                    
                    if (!jsonDataRaw || jsonDataRaw.length === 0) {
                        throw new Error('The Excel sheet is empty or contains no data rows below the headers.');
                    }

                    const headers = Object.keys(jsonDataRaw[0]);
                    const firstKey = headers.find(h => h.trim().toLowerCase() === 'first');
                    const lastKey = headers.find(h => h.trim().toLowerCase() === 'last');
                    const marketKey = headers.find(h => h.trim().toLowerCase() === 'market');

                    if (firstKey && lastKey && marketKey) {
                        traineeData = jsonDataRaw
                            .filter(row => row[firstKey] && row[lastKey] && row[marketKey])
                            .map(row => ({ 
                                name: `${row[firstKey]} ${row[lastKey]}`.trim(), 
                                region: row[marketKey],
                                id: Math.random().toString(36).substr(2, 9) 
                            }))
                            .filter(t => t.name && t.region);
                        
                        if (traineeData.length === 0) {
                            throw new Error('No valid trainee data found. Please check that the "First", "Last", and "MARKET" columns are populated with data.');
                        }

                        displayDataPreview(traineeData);
                        extractUniqueRegions();
                        populateTrainersUI();
                        populatePairingUI();
                        nextBtn.classList.remove('hidden');
                    } else {
                        throw new Error('Columns "First", "Last", and "MARKET" not found. Please check the column headers in your file.');
                    }
                } catch (error) {
                    console.error("File reading error:", error);
                    alert(`Failed to process the file. Please check the following:\n1. The file is a valid Excel (.xlsx, .xls) or .csv file.\n2. It contains columns named "First", "Last", and "MARKET".\n3. There is at least one row of data under the headers.\n\nError details: ${error.message}`);
                    traineeData = [];
                    document.getElementById('file-name').textContent = 'Upload failed. Please try again.';
                    document.getElementById('data-preview').classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Manual Entry Logic
        const createManualTraineeInput = () => {
            const div = document.createElement('div');
            div.className = 'manual-trainee-entry flex items-center space-x-4 p-4 bg-gray-50 rounded-lg';
            div.innerHTML = `
                <div class="flex-1"><label class="block text-sm font-medium text-gray-700">First Name</label><input type="text" class="mt-1 trainee-first-name w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., John"></div>
                <div class="flex-1"><label class="block text-sm font-medium text-gray-700">Last Name</label><input type="text" class="mt-1 trainee-last-name w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Doe"></div>
                <div class="flex-1"><label class="block text-sm font-medium text-gray-700">Market</label><input type="text" class="mt-1 trainee-market w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., SEPA"></div>
                <button class="remove-manual-trainee-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 self-end mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`;
            div.querySelector('.remove-manual-trainee-btn').addEventListener('click', () => div.remove());
            return div;
        };
        
        const populateManualTraineeUI = () => {
            const container = document.getElementById('manual-trainees-list');
            container.innerHTML = '';
            container.appendChild(createManualTraineeInput());
        };

        addManualTraineeBtn.addEventListener('click', () => {
            document.getElementById('manual-trainees-list').appendChild(createManualTraineeInput());
        });

        const saveManualTrainees = () => {
            traineeData = [];
            document.querySelectorAll('.manual-trainee-entry').forEach(entry => {
                const firstName = entry.querySelector('.trainee-first-name').value.trim();
                const lastName = entry.querySelector('.trainee-last-name').value.trim();
                const market = entry.querySelector('.trainee-market').value.trim();
                if (firstName && lastName && market) {
                    traineeData.push({
                        name: `${firstName} ${lastName}`,
                        region: market,
                        id: Math.random().toString(36).substr(2, 9)
                    });
                }
            });
            extractUniqueRegions();
            populateTrainersUI();
            populatePairingUI();
        };

        const displayDataPreview = (data) => {
            const previewHeader = document.getElementById('preview-header');
            const previewBody = document.getElementById('preview-body');
            previewHeader.innerHTML = ''; previewBody.innerHTML = '';
            const headers = ['Name', 'MARKET'];
            const headerRow = document.createElement('tr');
            headers.forEach(h => headerRow.innerHTML += `<th class="px-4 py-2 text-left">${h}</th>`);
            previewHeader.appendChild(headerRow);
            data.slice(0, 5).forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-t';
                tr.innerHTML += `<td class="px-4 py-2">${row.name}</td>`;
                tr.innerHTML += `<td class="px-4 py-2">${row.region}</td>`;
                previewBody.appendChild(tr);
            });
            document.getElementById('data-preview').classList.remove('hidden');
        };

        const extractUniqueRegions = () => {
            uniqueRegions = Array.from(new Set(traineeData.map(t => t.region))).sort();
        };

        // --- STEP 2: TRAINER MANAGEMENT ---
        const createTrainerInput = (trainer = { id: Date.now(), name: '', region: '' }) => {
            const div = document.createElement('div');
            div.className = 'trainer-entry flex items-center space-x-4 p-4 bg-gray-50 rounded-lg';
            div.dataset.id = trainer.id;
            const regionOptions = uniqueRegions.map(r => `<option value="${r}" ${trainer.region === r ? 'selected' : ''}>${r}</option>`).join('');
            div.innerHTML = `
                <div class="flex-1"><label class="block text-sm font-medium text-gray-700">Trainer Name</label><input type="text" value="${trainer.name}" class="mt-1 trainer-name w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., John Walsh"></div>
                <div class="flex-1"><label class="block text-sm font-medium text-gray-700">Market/Region</label><select class="mt-1 trainer-region w-full p-2 border border-gray-300 rounded-lg bg-white"><option value="">Select Market</option>${regionOptions}</select></div>
                <button class="remove-trainer-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 self-end mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`;
            div.querySelector('.remove-trainer-btn').addEventListener('click', () => div.remove());
            return div;
        };

        const populateTrainersUI = () => {
            const container = document.getElementById('trainers-list');
            container.innerHTML = '';
            if (trainers.length > 0) {
                trainers.forEach(trainer => container.appendChild(createTrainerInput(trainer)));
            } else {
                container.appendChild(createTrainerInput());
            }
        };

        addTrainerBtn.addEventListener('click', () => {
            document.getElementById('trainers-list').appendChild(createTrainerInput());
        });
        
        const saveTrainers = () => {
            trainers = [];
            document.querySelectorAll('.trainer-entry').forEach(entry => {
                const name = entry.querySelector('.trainer-name').value.trim();
                const region = entry.querySelector('.trainer-region').value;
                if (name && region) {
                    trainers.push({ id: entry.dataset.id, name, region });
                }
            });
            saveData();
            populatePairingUI();
        };

        // --- STEP 3: PAIRING LOGIC ---
        const populatePairingUI = () => {
            const container = document.getElementById('pairing-container');
            container.innerHTML = (traineeData.length === 0) ? `<p class="text-gray-500 text-center">Upload or enter trainee data in Step 1.</p>` : '';
            traineeData.forEach(trainee => {
                const trainersInRegion = trainers.filter(t => t.region === trainee.region);
                const trainerOptions = trainersInRegion.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
                const div = document.createElement('div');
                div.className = 'pairing-entry bg-white p-4 rounded-lg shadow-sm border';
                div.dataset.traineeId = trainee.id;
                div.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                        <div><p class="font-bold text-lg text-gray-800">${trainee.name}</p><p class="text-sm text-gray-500">${trainee.region}</p></div>
                        <div><label class="block text-sm font-medium text-gray-700">Assign Trainer</label><select class="pairing-trainer-select mt-1 w-full p-2 border border-gray-300 rounded-lg bg-white" ${trainersInRegion.length === 0 ? 'disabled' : ''}><option value="">${trainersInRegion.length === 0 ? 'No trainers' : 'Select trainer'}</option>${trainerOptions}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Order #</label><input type="text" class="pairing-order-input mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g. 632261"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" class="pairing-start-date mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-gray-700">End Date</label><input type="date" class="pairing-end-date mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                    </div>`;
                container.appendChild(div);
            });
        };

        const savePairings = () => {
            pairings = [];
            document.querySelectorAll('.pairing-entry').forEach(entry => {
                const trainee = traineeData.find(t => t.id === entry.dataset.traineeId);
                const trainerName = entry.querySelector('.pairing-trainer-select').value;
                const order = entry.querySelector('.pairing-order-input').value.trim();
                const startDate = entry.querySelector('.pairing-start-date').value;
                const endDate = entry.querySelector('.pairing-end-date').value;
                if (trainee && trainerName && order && startDate && endDate) {
                    pairings.push({ traineeName: trainee.name, trainerName, order, startDate, endDate });
                }
            });
        };

        // --- STEP 4: CALENDAR ---
        const renderCalendar = () => {
            const gridBody = document.getElementById('calendar-grid-body');
            gridBody.innerHTML = '';
            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            document.getElementById('calendar-month-year').textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) { gridBody.appendChild(document.createElement('div')); }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day border p-2 bg-white';
                dayCell.innerHTML = `<div class="font-bold text-right">${day}</div>`;
                const currentDate = new Date(year, month, day);

                pairings.forEach(p => {
                    const startDate = new Date(p.startDate + 'T00:00:00');
                    const endDate = new Date(p.endDate + 'T00:00:00');
                    if (currentDate >= startDate && currentDate <= endDate) {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'calendar-event text-white';
                        eventDiv.textContent = p.traineeName;
                        let hash = 0;
                        for (let i = 0; i < p.trainerName.length; i++) { hash = p.trainerName.charCodeAt(i) + ((hash << 5) - hash); }
                        const color = `hsl(${hash % 360}, 70%, 50%)`;
                        eventDiv.style.backgroundColor = color;
                        dayCell.appendChild(eventDiv);
                    }
                });
                gridBody.appendChild(dayCell);
            }
        };
        
        document.getElementById('prev-month-btn').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

        // --- STEP 5: POST GENERATION & EXPORT ---
        const generatePost = () => {
            const market = document.getElementById('market-input').value || 'SEPA Market';
            const week = document.getElementById('week-input').value || `Week of ${new Date().toLocaleDateString()}`;
            const postOutput = document.getElementById('post-output');
            if (pairings.length === 0) { return postOutput.value = "No pairings created."; }

            const pairingsByTrainer = pairings.reduce((acc, p) => {
                acc[p.trainerName] = acc[p.trainerName] || [];
                acc[p.trainerName].push(p);
                return acc;
            }, {});

            let postContent = `${market} - ${week}\n\nGood evening,\n\nSee the BWZ field training pairings for next week below.\n\n`;
            for (const trainerName in pairingsByTrainer) {
                postContent += `${trainerName}\n`;
                pairingsByTrainer[trainerName].forEach(p => {
                    const start = new Date(p.startDate + 'T00:00:00');
                    const end = new Date(p.endDate + 'T00:00:00');
                    const duration = `${start.toLocaleDateString('en-US', { weekday: 'short' })} - ${end.toLocaleDateString('en-US', { weekday: 'short' })}`;
                    postContent += ` - ${p.traineeName} - ${duration} - ${p.order}*\n`;
                });
                postContent += "\n";
            }
            postContent += "Please let me know if you need additional time beyond what is currently scheduled with your trainees.  Thank you everyone! ðŸ™‚";
            postOutput.value = postContent;
        };

        copyPostBtn.addEventListener('click', () => {
            const postOutput = document.getElementById('post-output');
            navigator.clipboard.writeText(postOutput.value).then(() => {
                const successMsg = document.getElementById('copy-success');
                successMsg.classList.remove('hidden');
                setTimeout(() => successMsg.classList.add('hidden'), 2000);
            }).catch(() => alert('Failed to copy.'));
        });
        
        const generateICSFile = () => {
            if (pairings.length === 0) {
                alert("Please create some pairings first before exporting to calendar.");
                return;
            }

            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//PairingsGuide//EN',
            ];

            pairings.forEach(p => {
                const startDate = new Date(p.startDate);
                const endDate = new Date(p.endDate);
                endDate.setDate(endDate.getDate() + 1); // .ics end date is exclusive

                const formatDate = (date) => date.toISOString().split('T')[0].replace(/-/g, '');
                
                const event = [
                    'BEGIN:VEVENT',
                    `UID:${Date.now()}-${p.traineeName.replace(/\s/g, '')}@pairings.guide`,
                    `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}Z`,
                    `DTSTART;VALUE=DATE:${formatDate(startDate)}`,
                    `DTEND;VALUE=DATE:${formatDate(endDate)}`,
                    `SUMMARY:Training: ${p.traineeName} w/ ${p.trainerName}`,
                    `DESCRIPTION:Field training for ${p.traineeName} with ${p.trainerName}.\\nOrder #: ${p.order}`,
                    'END:VEVENT'
                ];
                icsContent.push(...event);
            });

            icsContent.push('END:VCALENDAR');
            return icsContent.join('\r\n');
        };

        downloadIcsBtn.addEventListener('click', () => {
            const icsData = generateICSFile();
            if (icsData) {
                const blob = new Blob([icsData], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'training_schedule.ics';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });

        // --- INITIALIZATION ---
        window.onload = () => {
            loadData();
            updateGuideUI();
            populateTrainersUI();
        };
    </script>

</body>
</html>
